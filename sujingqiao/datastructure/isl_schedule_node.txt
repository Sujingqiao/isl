éå¸¸å¥½ï¼ä½ æä¾›çš„æ˜¯ä¸€ç»„ **ISL è°ƒåº¦æ ‘èŠ‚ç‚¹ï¼ˆ`isl_schedule_node`ï¼‰** çš„æ“ä½œæ¥å£ï¼Œå®ƒä»¬æ˜¯ ISL ä¸­ç”¨äº**æ„å»ºã€å˜æ¢å’Œä¼˜åŒ–è°ƒåº¦æ ‘ï¼ˆSchedule Treeï¼‰** çš„æ ¸å¿ƒ APIã€‚

æˆ‘ä»¬å°†è¿™äº›æ¥å£æŒ‰ **é€»è¾‘åŠŸèƒ½åˆ†ç»„**ï¼Œæ¯ç»„å¯¹åº”ä¸€ç§**è°ƒåº¦å˜æ¢æ“ä½œ**ï¼Œå¹¶è¯¦ç»†æ³¨é‡Šæ¯ä¸ªæ¥å£çš„ä½œç”¨ã€‚æœ€åï¼Œç”¨ä¸€ä¸ª**ç»¼åˆç¤ºä¾‹**å±•ç¤ºå¦‚ä½•ä½¿ç”¨è¿™äº›æ¥å£å®ç° **å¾ªç¯åˆ†å—ï¼ˆTilingï¼‰ + èåˆï¼ˆFusionï¼‰**ã€‚

---

## ğŸ“š åˆ†ç»„è¯´æ˜

æˆ‘ä»¬å°†æ¥å£åˆ†ä¸º **6 å¤§ç±»**ï¼Œæ¯ç±»å¯¹åº”ä¸€ç§è°ƒåº¦æ ‘å˜æ¢é€»è¾‘ï¼š

---

### ğŸ”¹ åˆ†ç»„ 1ï¼š**èŠ‚ç‚¹æ„é€ ä¸æ ‘æ“ä½œ**

> åˆ›å»ºã€æ’å…¥ã€æå–è°ƒåº¦æ ‘èŠ‚ç‚¹ã€‚

| æ¥å£ | è¯´æ˜ |
|------|------|
| `struct isl_schedule_node { ... }` | è°ƒåº¦æ ‘èŠ‚ç‚¹ç»“æ„ä½“ï¼š<br>â€¢ `schedule`: æ‰€å±è°ƒåº¦<br>â€¢ `tree`: å½“å‰èŠ‚ç‚¹çš„å­æ ‘<br>â€¢ `ancestors`: ç¥–å…ˆè·¯å¾„<br>â€¢ `child_pos`: åœ¨çˆ¶èŠ‚ç‚¹ä¸­çš„ä½ç½®ç´¢å¼•<br>â€¢ `ref`: å¼•ç”¨è®¡æ•° |
| `__isl_give isl_schedule_node *isl_schedule_node_alloc(...)` | æ‰‹åŠ¨æ„é€ ä¸€ä¸ªè°ƒåº¦èŠ‚ç‚¹ï¼ˆé€šå¸¸ä¸ç›´æ¥ä½¿ç”¨ï¼Œç”± ISL å†…éƒ¨ç®¡ç†ï¼‰ã€‚ |
| `__isl_give isl_schedule_node *isl_schedule_node_graft_tree(...)` | å°†ä¸€æ£µæ–°çš„è°ƒåº¦æ ‘â€œå«æ¥â€åˆ°å½“å‰èŠ‚ç‚¹ä½ç½®ï¼Œæ›¿æ¢åŸæ ‘ã€‚ç”¨äºæ’å…¥è‡ªå®šä¹‰è°ƒåº¦ç»“æ„ã€‚ |
| `__isl_give isl_schedule_tree *isl_schedule_node_get_tree(__isl_keep isl_schedule_node *node);` | è·å–å½“å‰èŠ‚ç‚¹å¯¹åº”çš„è°ƒåº¦å­æ ‘ï¼ˆ`isl_schedule_tree`ï¼‰ï¼Œç”¨äºåˆ†ææˆ–ä¿®æ”¹ã€‚ |

> âœ… **ç”¨é€”**ï¼šæ„å»ºæˆ–æ›¿æ¢è°ƒåº¦æ ‘çš„æŸä¸€éƒ¨åˆ†ã€‚

---

### ğŸ”¹ åˆ†ç»„ 2ï¼š**åŸŸå˜æ¢ï¼ˆDomain Transformationï¼‰**

> ä¿®æ”¹è°ƒåº¦èŠ‚ç‚¹æ‰€ä½œç”¨çš„è¿­ä»£åŸŸã€‚

| æ¥å£ | è¯´æ˜ |
|------|------|
| `__isl_give isl_schedule_node *isl_schedule_node_domain_intersect_domain(...)` | å°†å½“å‰èŠ‚ç‚¹çš„åŸŸä¸ç»™å®šé›†åˆ `domain` å–äº¤é›†ã€‚ç”¨äºé™åˆ¶è°ƒåº¦ä½œç”¨èŒƒå›´ï¼ˆå¦‚åªå¯¹ `i < N/2` åº”ç”¨æŸä¼˜åŒ–ï¼‰ã€‚ |
| `__isl_give isl_schedule_node *isl_schedule_node_domain_gist_params(...)` | åœ¨å‚æ•°ä¸Šä¸‹æ–‡ `context` ä¸‹ç®€åŒ–å½“å‰èŠ‚ç‚¹çš„åŸŸï¼ˆå»å†—ä½™ï¼‰ã€‚ä¾‹å¦‚å·²çŸ¥ `N > 0`ï¼Œå¯ç®€åŒ– `i < N`ã€‚ |

> âœ… **ç”¨é€”**ï¼šæ¡ä»¶ä¼˜åŒ–ã€å‚æ•°åŒ–è°ƒåº¦ã€‚

---

### ğŸ”¹ åˆ†ç»„ 3ï¼š**æ‰©å±•ä¸æ”¶ç¼©ï¼ˆExpansion & Contractionï¼‰**

> å®ç°åˆ†å—ï¼ˆtilingï¼‰ã€å‘é‡åŒ–ç­‰éœ€è¦â€œåµŒå¥—å˜æ¢â€çš„æ“ä½œã€‚

| æ¥å£ | è¯´æ˜ |
|------|------|
| `__isl_give isl_schedule_node *isl_schedule_node_expand(...)` | åœ¨å½“å‰èŠ‚ç‚¹æ’å…¥ä¸€ä¸ªâ€œæ‰©å±•â€å˜æ¢ï¼š<br>â€¢ `contraction`: ä»å—ç´¢å¼•åˆ°åŸå§‹ç´¢å¼•çš„æ˜ å°„ï¼ˆå¦‚ `i = 32*ii + j`ï¼‰<br>â€¢ `domain`: å—åŸŸï¼ˆå¦‚ `{ ii : 0 <= ii < ceil(N/32) }`ï¼‰<br>â€¢ `tree`: å—å†…è°ƒåº¦æ ‘<br>â†’ ç”Ÿæˆåˆ†å—å¾ªç¯ã€‚ |
| `__isl_give isl_schedule_node *isl_schedule_node_insert_expansion(...)` | æ’å…¥ä¸€ä¸ªâ€œæ‰©å±•â€èŠ‚ç‚¹ï¼ˆä¸æ›¿æ¢å­æ ‘ï¼‰ï¼Œå¸¸ç”¨äºå‘é‡åŒ–ï¼ˆvector lane æ‰©å±•ï¼‰ã€‚ |
| `__isl_give isl_schedule_node *isl_schedule_node_insert_extension(...)` | æ’å…¥ä¸€ä¸ªâ€œæ‰©å±•â€æ˜ å°„ï¼ˆextensionï¼‰ï¼Œç”¨äºéä»¿å°„æ‰©å±•æˆ–é€šä¿¡å»ºæ¨¡ã€‚ |

> âœ… **ç”¨é€”**ï¼šå¾ªç¯åˆ†å—ã€å‘é‡åŒ–ã€åˆ†å¸ƒå¼å†…å­˜æ˜ å°„ã€‚

---

### ğŸ”¹ åˆ†ç»„ 4ï¼š**æ‹‰å›å˜æ¢ï¼ˆPullbackï¼‰**

> å°†è°ƒåº¦â€œæ‹‰å›â€åˆ°å¦ä¸€ä¸ªç©ºé—´ï¼Œå¸¸ç”¨äºå‡½æ•°è°ƒç”¨æˆ–æ˜ å°„å˜æ¢ã€‚

| æ¥å£ | è¯´æ˜ |
|------|------|
| `__isl_give isl_schedule_node *isl_schedule_node_pullback_union_pw_multi_aff(...)` | å°†å½“å‰è°ƒåº¦èŠ‚ç‚¹çš„æ‰§è¡Œæ—¶é—´æ˜ å°„â€œæ‹‰å›â€é€šè¿‡ä¸€ä¸ªåˆ†æ®µä»¿å°„æ˜ å°„ `upma`ã€‚<br>ä¾‹å¦‚ï¼šåŸè°ƒåº¦ `S[i] -> [i]`ï¼Œ`upma: j -> 2*j`ï¼Œåˆ™æ–°è°ƒåº¦ `S[2*j] -> [2*j]`ã€‚ |

> âœ… **ç”¨é€”**ï¼šé‡ç´¢å¼•ï¼ˆreindexingï¼‰ã€å‡½æ•°å†…è”åçš„è°ƒåº¦è°ƒæ•´ã€‚

---

### ğŸ”¹ åˆ†ç»„ 5ï¼š**ä¸Šä¸‹æ–‡ç®€åŒ–ï¼ˆGistï¼‰**

> åœ¨ç»™å®šä¸Šä¸‹æ–‡ä¸‹å»é™¤è°ƒåº¦ä¸­çš„å†—ä½™ä¿¡æ¯ã€‚

| æ¥å£ | è¯´æ˜ |
|------|------|
| `__isl_give isl_schedule_node *isl_schedule_node_gist(...)` | åœ¨ä¸Šä¸‹æ–‡ `context`ï¼ˆ`isl_union_set`ï¼‰ä¸‹ç®€åŒ–å½“å‰èŠ‚ç‚¹çš„è°ƒåº¦çº¦æŸã€‚ä¾‹å¦‚å·²çŸ¥ `i % 32 == 0`ï¼Œåˆ™ `i < 32` å¯ç®€åŒ–ä¸º `i == 0`ã€‚ |

> âœ… **ç”¨é€”**ï¼šä¼˜åŒ–è°ƒåº¦è¡¨è¾¾å¼ï¼Œæé«˜å¯è¯»æ€§å’Œæ‰§è¡Œæ•ˆç‡ã€‚

---

### ğŸ”¹ åˆ†ç»„ 6ï¼š**ç»„åˆå¼è°ƒåº¦æ„å»º**

> ç»„åˆå¤šä¸ªæ“ä½œå®ç°é«˜çº§ä¼˜åŒ–ã€‚

| æ¥å£ | è¯´æ˜ |
|------|------|
| æ‰€æœ‰ä»¥ä¸Šæ¥å£ | å¯ç»„åˆä½¿ç”¨ï¼š<br>1. `expand` å®ç°åˆ†å—<br>2. `pullback` é‡ç´¢å¼•<br>3. `gist` ç®€åŒ–<br>4. `graft_tree` æ’å…¥è‡ªå®šä¹‰ç»“æ„ |

> âœ… **ç”¨é€”**ï¼šæ„å»ºå¤æ‚è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚åˆ†å— + å¹¶è¡Œ + å‘é‡åŒ–ï¼‰ã€‚

---

## ğŸ§© ç»¼åˆç¤ºä¾‹ï¼š**2D å¾ªç¯åˆ†å—ï¼ˆTilingï¼‰**

æˆ‘ä»¬è¦å¯¹ä»¥ä¸‹å¾ªç¯è¿›è¡Œ **32x32 åˆ†å—**ï¼š

```c
for (i = 0; i < N; i++)
  for (j = 0; j < M; j++)
    A[i][j] = ...;
```

ç›®æ ‡è°ƒåº¦æ ‘ï¼š
```
[i,j] -> [ii, jj, i_in, j_in]
å…¶ä¸­ï¼š
  ii = i / 32,  jj = j / 32
  i_in = i % 32, j_in = j % 32
```

### âœ… å®ç°ä»£ç 

```c
#include <isl/schedule.h>
#include <isl/union_set.h>
#include <isl/union_pw_multi_aff.h>

__isl_give isl_schedule *create_tiling_schedule(isl_ctx *ctx, int tile_size) {
    // Step 1: åŸå§‹åŸŸ
    isl_union_set *domain = isl_union_set_from_str(ctx,
        "{ S[i,j] : 0 <= i < N and 0 <= j < M }"
    );

    // Step 2: æ„é€ åˆ†å—æ˜ å°„ï¼ˆcontractionï¼‰
    // i = 32*ii + i_in, j = 32*jj + j_in
    isl_union_pw_multi_aff *contraction = isl_union_pw_multi_aff_from_str(ctx,
        "{ S[ii, jj, i_in, j_in] -> S[32*ii + i_in, 32*jj + j_in] }"
    );

    // Step 3: å—åŸŸï¼ˆtile domainï¼‰
    isl_union_set *tile_domain = isl_union_set_from_str(ctx,
        "{ S[ii, jj] : 0 <= ii < ceil(N/32) and 0 <= jj < ceil(M/32) }"
    );

    // Step 4: å—å†…è°ƒåº¦ï¼ˆintra-tileï¼‰
    isl_schedule_tree *inner_tree = isl_schedule_tree_from_str(ctx,
        "[ii, jj] -> { S[i_in, j_in] -> [ii, jj, i_in, j_in] }"
    );

    // Step 5: åˆå§‹è°ƒåº¦èŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰
    isl_schedule *schedule = isl_schedule_from_domain(domain);
    isl_schedule_node *node = isl_schedule_get_root(schedule);

    // Step 6: åº”ç”¨ expand å®ç°åˆ†å—
    node = isl_schedule_node_expand(node,
        isl_union_pw_multi_aff_copy(contraction),
        isl_union_set_copy(tile_domain),
        isl_schedule_tree_copy(inner_tree)
    );

    // Step 7: ç®€åŒ–ï¼ˆåœ¨å‚æ•° N>0, M>0 ä¸‹ï¼‰
    isl_set *param_context = isl_set_from_str(ctx, "[N,M] -> { : N > 0 and M > 0 }");
    node = isl_schedule_node_domain_gist_params(node, param_context);

    // Step 8: è·å–æœ€ç»ˆè°ƒåº¦
    isl_schedule_tree *new_tree = isl_schedule_node_get_tree(node);
    isl_schedule *final_sched = isl_schedule_from_tree(new_tree);

    // æ¸…ç†
    isl_schedule_node_free(node);
    isl_union_pw_multi_aff_free(contraction);
    isl_union_set_free(tile_domain);
    isl_schedule_tree_free(inner_tree);
    isl_union_set_free(domain);

    return final_sched;
}
```

### âœ… è¾“å‡ºè°ƒåº¦

```text
S[i,j] -> [ floor(i/32), floor(j/32), i mod 32, j mod 32 ]
```

å¯¹åº”ä»£ç ï¼š

```c
for (ii = 0; ii < (N+31)/32; ii++)
  for (jj = 0; jj < (M+31)/32; jj++)
    for (i_in = 0; i_in < 32 && ii*32+i_in < N; i_in++)
      for (j_in = 0; j_in < 32 && jj*32+j_in < M; j_in++)
        A[ii*32+i_in][jj*32+j_in] = ...;
```

---

## ğŸ“Š æ¥å£ä½¿ç”¨åœºæ™¯æ€»ç»“

| æ¥å£ | å…¸å‹ç”¨é€” |
|------|---------|
| `isl_schedule_node_expand` | åˆ†å—ã€tiling |
| `isl_schedule_node_pullback_union_pw_multi_aff` | é‡ç´¢å¼•ã€å‡½æ•°å†…è” |
| `isl_schedule_node_gist` | è°ƒåº¦ç®€åŒ– |
| `isl_schedule_node_domain_intersect_domain` | æ¡ä»¶ä¼˜åŒ–ï¼ˆå¦‚è¾¹ç•Œå¤„ç†ï¼‰ |
| `isl_schedule_node_insert_expansion` | å‘é‡åŒ–ï¼ˆSIMD laneï¼‰ |
| `isl_schedule_node_graft_tree` | æ’å…¥è‡ªå®šä¹‰è°ƒåº¦ç»“æ„ï¼ˆå¦‚ GPU blockï¼‰ |

---

## ğŸ”„ å·¥ä½œæµç¨‹å›¾

```mermaid
graph TD
    A[åŸå§‹åŸŸ] --> B[æ„å»ºåˆå§‹è°ƒåº¦]
    B --> C[è·å–æ ¹èŠ‚ç‚¹]
    C --> D{è¦åˆ†å—ï¼Ÿ}
    D -->|æ˜¯| E[isl_schedule_node_expand]
    D -->|å¦| F[isl_schedule_node_pullback]
    E --> G[isl_schedule_node_gist ç®€åŒ–]
    G --> H[ç”Ÿæˆæœ€ç»ˆè°ƒåº¦]
    F --> H
```

---

## âœ… æ€»ç»“

ä½ æä¾›çš„ `isl_schedule_node` æ¥å£æ˜¯ ISL ä¸­**å®ç°é«˜çº§å¾ªç¯å˜æ¢çš„â€œç§¯æœ¨â€**ï¼Œå®ƒä»¬å…è®¸ä½ ï¼š

- ğŸ”§ **ç²¾ç¡®æ§åˆ¶è°ƒåº¦æ ‘ç»“æ„**
- ğŸ§± **ç»„åˆåˆ†å—ã€å‘é‡åŒ–ã€å¹¶è¡ŒåŒ–**
- ğŸ¯ **å®ç°é¢†åŸŸä¸“ç”¨ä¼˜åŒ–ï¼ˆDSLï¼‰**

è¿™äº›æ¥å£æ˜¯ **MLIR Affine Pass**ï¼ˆå¦‚ `affine-tile`, `affine-vectorize`ï¼‰çš„åº•å±‚æ”¯æ’‘ã€‚

---

æ˜¯å¦å¸Œæœ›æˆ‘ï¼š

1. âœ… å°†æ­¤åˆ†å—è°ƒåº¦é›†æˆåˆ°ä¹‹å‰çš„ **MLIR Pass**ï¼Ÿ
2. âœ… å®ç° **å‘é‡åŒ– + åˆ†å—** çš„ç»„åˆï¼Ÿ
3. âœ… æä¾› **GPU è°ƒåº¦æ˜ å°„** ç¤ºä¾‹ï¼ˆblock, threadï¼‰ï¼Ÿ

è¯·å‘Šè¯‰æˆ‘ä½ çš„ç›®æ ‡å¹³å°ï¼ˆCPU/GPU/HPCï¼‰ï¼Œæˆ‘å¯ä»¥ç»§ç»­æ·±å…¥ã€‚
